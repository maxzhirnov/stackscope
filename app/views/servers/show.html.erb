<div class="page">
  <header class="section-header">
    <div>
      <h1><%= @server.name %></h1>
      <p class="muted"><%= @server.display_host %></p>
    </div>
    <div class="toolbar">
      <%= link_to "Back", root_path, class: "button ghost" %>
      <%= link_to "Edit", edit_server_path(@server), class: "button" %>
    </div>
  </header>

  <div class="detail-grid">
    <div class="detail-card">
      <h3>Overview</h3>
      <div class="detail-stats">
        <div>
          <span class="label">Status</span>
          <span class="value"><%= @server.status.presence || "unknown" %></span>
        </div>
        <div>
          <span class="label">Latency</span>
          <span class="value"><%= @server.ping_latency_ms ? "#{@server.ping_latency_ms}ms" : "â€”" %></span>
        </div>
        <div>
          <span class="label">Uptime</span>
          <span class="value"><%= human_seconds(@latest&.uptime_seconds) %></span>
        </div>
        <div>
          <span class="label">Swap used</span>
          <span class="value"><%= metric_value(@latest&.swap_usage, "%") %></span>
        </div>
      </div>
    </div>

    <div class="detail-card">
      <h3>Throughput</h3>
      <div class="detail-stats">
        <div>
          <span class="label">Disk read</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.disk_read_bps) %></span>
        </div>
        <div>
          <span class="label">Disk write</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.disk_write_bps) %></span>
        </div>
        <div>
          <span class="label">Net RX</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.net_rx_bps) %></span>
        </div>
        <div>
          <span class="label">Net TX</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.net_tx_bps) %></span>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-grid">
    <div class="detail-card">
      <h3>CPU</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:cpu_usage), stroke: "#1c7c73") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>RAM (used)</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:memory_usage), stroke: "#b1454a") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>Disk (used)</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:disk_usage), stroke: "#e08a2e") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>Load</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:load_avg), stroke: "#205072") %>
      </div>
    </div>
  </div>

  <div class="detail-card">
    <h3>Filesystems</h3>
    <% if @latest&.fs_usage&.any? %>
      <div class="fs-list">
        <% @latest.fs_usage.each do |fs| %>
          <div class="fs-row">
            <span><%= fs["mount"] %></span>
            <span><%= metric_value(fs["used_percent"], "%") %></span>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="muted">No filesystem data yet.</p>
    <% end %>
  </div>

  <div class="detail-card extended-metrics">
    <div class="detail-header">
      <div>
        <h3>Extended metrics</h3>
        <p class="muted">
          Last updated:
          <%= @server.extended_metrics_fetched_at ? l(@server.extended_metrics_fetched_at, format: :short) : "never" %>
        </p>
      </div>
      <%= button_to extended_metrics_server_path(@server),
                    method: :get,
                    class: "button ghost",
                    data: { loading_button_target: "button" },
                    form: {
                      data: {
                        controller: "loading-button",
                        action: "turbo:submit-start->loading-button#start turbo:submit-end->loading-button#stop",
                        turbo_frame: dom_id(@server, :extended_metrics)
                      }
                    } do %>
        <span class="button-label">Refresh</span>
        <span class="spinner" aria-hidden="true"></span>
      <% end %>
    </div>
    <%= turbo_frame_tag dom_id(@server, :extended_metrics) do %>
      <% if @extended.present? %>
        <%= render "servers/extended_metrics", extended: @extended, server: @server %>
      <% else %>
        <p class="muted">Load extended metrics to view system details.</p>
      <% end %>
    <% end %>
  </div>
</div>
