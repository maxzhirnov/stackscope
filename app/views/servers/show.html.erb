<div class="page">
  <header class="section-header">
    <div>
      <h1><%= @server.name %></h1>
      <p class="muted"><%= @server.display_host %></p>
    </div>
    <div class="toolbar">
      <%= link_to "Back", root_path, class: "button ghost" %>
      <%= link_to "Edit", edit_server_path(@server), class: "button" %>
    </div>
  </header>

  <div class="detail-grid">
    <div class="detail-card">
      <h3>Overview</h3>
      <div class="detail-stats">
        <div>
          <span class="label">Status</span>
          <span class="value"><%= @server.status.presence || "unknown" %></span>
        </div>
        <div>
          <span class="label">Latency</span>
          <span class="value"><%= @server.ping_latency_ms ? "#{@server.ping_latency_ms}ms" : "—" %></span>
        </div>
        <div>
          <span class="label">Uptime</span>
          <span class="value"><%= human_seconds(@latest&.uptime_seconds) %></span>
        </div>
        <div>
          <span class="label">Swap used</span>
          <span class="value"><%= metric_value(@latest&.swap_usage, "%") %></span>
        </div>
      </div>
    </div>

    <div class="detail-card">
      <h3>Throughput</h3>
      <div class="detail-stats">
        <div>
          <span class="label">Disk read</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.disk_read_bps) %></span>
        </div>
        <div>
          <span class="label">Disk write</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.disk_write_bps) %></span>
        </div>
        <div>
          <span class="label">Net RX</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.net_rx_bps) %></span>
        </div>
        <div>
          <span class="label">Net TX</span>
          <span class="value"><%= human_bytes_per_sec(@latest&.net_tx_bps) %></span>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-grid">
    <div class="detail-card">
      <h3>CPU</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:cpu_usage), stroke: "#1c7c73") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>RAM (used)</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:memory_usage), stroke: "#b1454a") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>Disk (used)</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:disk_usage), stroke: "#e08a2e") %>
      </div>
    </div>
    <div class="detail-card">
      <h3>Load</h3>
      <div class="sparkline-wrap">
        <%= sparkline(@samples.map(&:load_avg), stroke: "#205072") %>
      </div>
    </div>
  </div>

  <div class="detail-card">
    <h3>Filesystems</h3>
    <% if @latest&.fs_usage&.any? %>
      <div class="fs-list">
        <% @latest.fs_usage.each do |fs| %>
          <div class="fs-row">
            <span><%= fs["mount"] %></span>
            <span><%= metric_value(fs["used_percent"], "%") %></span>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="muted">No filesystem data yet.</p>
    <% end %>
  </div>

  <div class="detail-card">
    <h3>Extended metrics</h3>
    <% if @extended.present? %>
      <% meta = @extended["meta"] || {} %>
      <% system = @extended["system"] || {} %>
      <% cpu = @extended["cpu"] || {} %>
      <% memory = @extended["memory"] || {} %>
      <% disk = @extended["disk"] || {} %>
      <% network = @extended["network"] || {} %>
      <% processes = @extended["processes"] || {} %>
      <% health = @extended["health"] || {} %>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>Agent</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Version</span>
              <span class="value"><%= @extended["agent_version"] || "—" %></span>
            </div>
            <div>
              <span class="label">Schema</span>
              <span class="value"><%= meta["schema_version"] || "—" %></span>
            </div>
            <div>
              <span class="label">Build</span>
              <span class="value"><%= meta.dig("agent_build", "build_time") || "—" %></span>
            </div>
            <div>
              <span class="label">Git</span>
              <span class="value"><%= meta.dig("agent_build", "git_sha") || "—" %></span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <h3>System</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Host</span>
              <span class="value"><%= system["hostname"] || "—" %></span>
            </div>
            <div>
              <span class="label">OS</span>
              <span class="value"><%= system.dig("os", "pretty_name") || system.dig("os", "name") || "—" %></span>
            </div>
            <div>
              <span class="label">Kernel</span>
              <span class="value"><%= system["kernel"] || "—" %></span>
            </div>
            <div>
              <span class="label">Arch</span>
              <span class="value"><%= system["arch"] || "—" %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>CPU</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Usage</span>
              <span class="value"><%= metric_value(cpu["usage_total_percent"], "%") %></span>
            </div>
            <div>
              <span class="label">Cores</span>
              <span class="value"><%= cpu["cores_logical"] || "—" %></span>
            </div>
            <div>
              <span class="label">IO wait</span>
              <span class="value"><%= metric_value(cpu["iowait_percent"], "%") %></span>
            </div>
            <div>
              <span class="label">Steal</span>
              <span class="value"><%= metric_value(cpu["steal_percent"], "%") %></span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <h3>Memory</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Total</span>
              <span class="value"><%= memory["total_mb"] ? "#{memory["total_mb"].round} MB" : "—" %></span>
            </div>
            <div>
              <span class="label">Used</span>
              <span class="value"><%= memory["used_mb"] ? "#{memory["used_mb"].round} MB" : "—" %></span>
            </div>
            <div>
              <span class="label">Available</span>
              <span class="value"><%= memory["available_mb"] ? "#{memory["available_mb"].round} MB" : "—" %></span>
            </div>
            <div>
              <span class="label">Cached</span>
              <span class="value"><%= memory["cached_mb"] ? "#{memory["cached_mb"].round} MB" : "—" %></span>
            </div>
            <div>
              <span class="label">Swap used</span>
              <span class="value"><%= metric_value(memory.dig("swap", "used_percent"), "%") %></span>
            </div>
            <div>
              <span class="label">OOM kills</span>
              <span class="value"><%= memory["oom_kills_total"] || 0 %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>Disk</h3>
          <% fs_list = disk["fs"] || [] %>
          <% if fs_list.any? %>
            <div class="detail-list">
              <% fs_list.each do |fs| %>
                <div class="detail-row">
                  <span><%= fs["mount"] %> (<%= fs["fstype"] %>)</span>
                  <span><%= metric_value(fs["used_percent"], "%") %> used</span>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="muted">No filesystem details yet.</p>
          <% end %>
        </div>

        <div class="detail-card">
          <h3>Network</h3>
          <% interfaces = network["interfaces"] || [] %>
          <% if interfaces.any? %>
            <div class="detail-list">
              <% interfaces.each do |iface| %>
                <div class="detail-row">
                  <span><%= iface["name"] %></span>
                  <span><%= human_bytes_per_sec(iface["rx_bps"]) %> / <%= human_bytes_per_sec(iface["tx_bps"]) %></span>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="muted">No network details yet.</p>
          <% end %>
        </div>
      </div>

      <div class="detail-grid">
        <div class="detail-card">
          <h3>Processes</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Total</span>
              <span class="value"><%= processes["total"] || "—" %></span>
            </div>
            <div>
              <span class="label">Zombies</span>
              <span class="value"><%= processes["zombies"] || 0 %></span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <h3>Health</h3>
          <div class="detail-stats">
            <div>
              <span class="label">Status</span>
              <span class="value"><%= health["status"] || "—" %></span>
            </div>
            <div>
              <span class="label">Reasons</span>
              <span class="value"><%= Array(health["reasons"]).join(", ").presence || "—" %></span>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <p class="muted">Extended metrics are unavailable. Install agent v0.0.5+ to enable this view.</p>
    <% end %>
  </div>
</div>
